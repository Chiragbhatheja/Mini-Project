<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - BreathWise Details</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #AEC6CF; 
            --bg-color: #FAF9F6;      
            --text-dark: #3a3b3c;
            --danger-color: #b91c1c; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-dark);
        }

        .auth-card {
            max-width: 600px;
            margin: 50px auto;
            padding: 40px;
            border-radius: 16px;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            text-align: center;
        }
        .profile-avatar {
            font-size: 5rem;
            color: var(--primary-color);
        }
        .btn-main, .btn-edit {
            background: var(--primary-color);
            color: #2c5a6d;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
        }
        .list-group-item {
            background-color: transparent;
            border-color: rgba(0, 0, 0, 0.08);
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* ADDED: Form styling for edit mode */
        .form-control, .form-select {
            border-radius: 8px;
            border-color: rgba(0, 0, 0, 0.1);
            background-color: rgba(0, 0, 0, 0.02);
            text-align: left;
        }
        .text-start {
            text-align: left !important;
        }
    </style>
</head>

<body>
    <div class="auth-card">
        
        <h2 class="fw-bold mb-4" id="card-title">User Profile</h2>

        <div id="loading-state">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Fetching full profile details...</p>
        </div>
        
        <div id="display-view" style="display: none;">
            <i class="bi bi-person-circle profile-avatar mb-3"></i>
            <h3 class="fw-bold" id="profile-name"></h3>
            <p class="text-secondary fs-5 mb-4" id="profile-email-display"></p>
            
            <hr class="my-3">
            
            <ul class="list-group list-group-flush text-start mb-4">
                <li class="list-group-item">
                    <span class="text-secondary fw-medium"><i class="bi bi-envelope me-2"></i>Email</span>
                    <span class="fw-bold" id="detail-email">N/A</span>
                </li>
                <li class="list-group-item">
                    <span class="text-secondary fw-medium"><i class="bi bi-calendar-event me-2"></i>Age</span>
                    <span class="fw-bold" id="detail-age">N/A</span>
                </li>
                <li class="list-group-item">
                    <span class="text-secondary fw-medium"><i class="bi bi-geo-alt me-2"></i>Location</span>
                    <span class="fw-bold" id="detail-location">N/A</span>
                </li>
                <li class="list-group-item">
                    <span class="text-secondary fw-medium"><i class="bi bi-heart me-2"></i>Health Profile</span>
                    <span class="fw-bold" id="detail-health-profile">N/A</span>
                </li>
                <li class="list-group-item">
                    <span class="text-secondary fw-medium"><i class="bi bi-calendar-check me-2"></i>Member Since</span>
                    <span class="fw-bold" id="detail-member-since">N/A</span>
                </li>
            </ul>
            
            <button id="edit-profile-btn" class="btn btn-main btn-edit me-3" onclick="toggleEditMode(true)">
                <i class="bi bi-pencil-square me-2"></i>
                Edit Profile
            </button>
            <button id="logout-btn-display" class="btn btn-danger">
                <i class="bi bi-box-arrow-right me-2"></i>
                Logout
            </button>
        </div>

        <div id="edit-view" style="display: none;">
            <h3 class="fw-bold mb-4 text-start">Edit Details</h3>
            <form id="profile-edit-form">
                <div class="mb-3 text-start">
                    <label for="input-name" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="input-name" required>
                </div>
                <div class="mb-3 text-start">
                    <label for="input-email" class="form-label">Email (Cannot be changed)</label>
                    <input type="email" class="form-control" id="input-email" disabled>
                </div>
                <div class="mb-3 text-start">
                    <label for="input-age" class="form-label">Age</label>
                    <input type="number" class="form-control" id="input-age" required>
                </div>
                <div class="mb-3 text-start">
                    <label for="input-location" class="form-label">Primary Location</label>
                    <input type="text" class="form-control" id="input-location" required>
                </div>
                <div class="mb-4 text-start">
                    <label for="input-health-profile" class="form-label">Health Profile</label>
                    <select class="form-select" id="input-health-profile" required>
                        <option value="General Adult">General Adult</option>
                        <option value="Sensitive Individual">Sensitive Individual</option>
                        <option value="Athlete">Athlete</option>
                    </select>
                </div>
                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="toggleEditMode(false)">Cancel</button>
                    <button type="submit" class="btn btn-main">Save Changes</button>
                </div>
            </form>
        </div>

        <div id="unauthenticated-message" style="display: none;">
            <i class="bi bi-lock text-danger fs-1 mb-3"></i>
            <h3 class="fw-bold">Access Denied</h3>
            <p class="text-secondary">No active session found. Please log in.</p>
            <a href="signup.html" class="btn btn-main mt-3">Login / Sign Up</a>
        </div>
        
    </div>

<script>
// --- Global State for profile data ---
let currentProfileData = {};

// --- CORE SIMULATION DATA (You can customize these for testing) ---
const SIMULATED_USER_DATA = {
    age: 35,
    location: 'San Francisco, CA',
    healthProfile: 'Sensitive Individual',
    memberSince: '2023-01-15',
    activeAlerts: 3
};

// --- AUTH HANDLERS ---

function handleLogout(e) {
    e.preventDefault();
    localStorage.removeItem('token');
    localStorage.removeItem('user_name');
    window.location.href = 'signup.html';
}

// --- DATA FETCHING (SIMULATED) ---

async function fetchAndDisplayProfile(token, userName) {
    let userEmail = 'Loading...'; 
    try {
        const decoded = jwt_decode(token); 
        // Use the email field if it exists in the token, otherwise default
        userEmail = decoded.email || `${userName.replace(/\s/g, '').toLowerCase()}@example.com`;
    } catch (e) {
        // If JWT decode fails (token invalid), this will be overwritten below
        userEmail = 'N/A - Token Error'; 
        console.warn("JWT Decode failed or token expired:", e);
    }
    
    // Simulate fetching full profile details
    await new Promise(resolve => setTimeout(resolve, 50)); 
    
    // Combine fetched/simulated data with the email extracted above
    const profile = {
        name: userName,
        email: userEmail,
        ...SIMULATED_USER_DATA,
        memberSince: SIMULATED_USER_DATA.memberSince
    };
    
    // Update global state
    currentProfileData = profile;

    // Update UI
    updateProfileUI(profile);
}

// --- UI UPDATE ---

function updateProfileUI(data) {
    document.getElementById('loading-state').style.display = 'none';
    document.getElementById('display-view').style.display = 'block';

    document.getElementById('profile-name').textContent = data.name;
    document.getElementById('profile-email-display').textContent = data.email;

    document.getElementById('detail-email').textContent = data.email;
    document.getElementById('detail-age').textContent = data.age;
    document.getElementById('detail-location').textContent = data.location;
    document.getElementById('detail-health-profile').textContent = data.healthProfile;
    document.getElementById('detail-member-since').textContent = new Date(data.memberSince).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

}

// --- EDIT MODE LOGIC ---

function toggleEditMode(enable) {
    const displayView = document.getElementById('display-view');
    const editView = document.getElementById('edit-view');

    if (enable) {
        // Switch to Edit Mode
        displayView.style.display = 'none';
        editView.style.display = 'block';
        
        // Populate the form with current data
        document.getElementById('input-name').value = currentProfileData.name;
        document.getElementById('input-email').value = currentProfileData.email; // Disabled field
        document.getElementById('input-age').value = currentProfileData.age;
        document.getElementById('input-location').value = currentProfileData.location;
        document.getElementById('input-health-profile').value = currentProfileData.healthProfile;

    } else {
        // Switch back to Display Mode
        displayView.style.display = 'block';
        editView.style.display = 'none';
    }
}

document.getElementById('profile-edit-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // 1. Collect updated data from form
    const updatedData = {
        name: document.getElementById('input-name').value,
        age: document.getElementById('input-age').value,
        location: document.getElementById('input-location').value,
        healthProfile: document.getElementById('input-health-profile').value
    };

    // 2. Simulate API Call (PUT /api/v1/profile)
    // In a real app, you would send this via fetch PUT request with token.
    document.getElementById('edit-view').innerHTML = '<div class="spinner-border text-primary"></div><p class="mt-3">Saving...</p>';
    await new Promise(resolve => setTimeout(resolve, 500)); 
    
    // 3. Update global state and local storage
    currentProfileData = { ...currentProfileData, ...updatedData };
    localStorage.setItem('user_name', updatedData.name); // Keep name updated for navbar
    
    // 4. Update UI and switch view
    updateProfileUI(currentProfileData);
    toggleEditMode(false); 
    alert('Profile updated successfully (Simulated)');
});


// --- INITIAL STATUS CHECK ---

function checkAuthStatus() {
    const token = localStorage.getItem('token');
    const userName = localStorage.getItem('user_name');
    
    const loadingState = document.getElementById('loading-state');
    const unauthenticatedMessage = document.getElementById('unauthenticated-message');

    if (token && userName) {
        // AUTHENTICATED: Start fetching details
        loadingState.style.display = 'block';
        unauthenticatedMessage.style.display = 'none';
        
        fetchAndDisplayProfile(token, userName);
        
    } else {
        // UNAUTHENTICATED: Show error immediately
        loadingState.style.display = 'none';
        unauthenticatedMessage.style.display = 'block';
    }
}

// Execute check on load
document.addEventListener('DOMContentLoaded', function() {
    // Attach event listeners to buttons
    document.getElementById('logout-btn-display')?.addEventListener('click', handleLogout);
    
    // Run auth check
    setTimeout(checkAuthStatus, 50); 
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>

</body>
</html>